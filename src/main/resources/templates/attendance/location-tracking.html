<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}">
    <title>Location Tracking - UPFSDA</title>
</head>
<body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/layout :: sidebar}"></nav>
    
    <!-- Header -->
    <header th:replace="~{fragments/layout :: header}"></header>
    
    <!-- Main Content -->
    <main class="main-content">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="page-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h1 class="page-title">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        Location Tracking
                                    </h1>
                                    <p class="page-subtitle">Real-time location monitoring and history</p>
                                </div>
                                <div id="userControls" style="display: none;">
                                    <div class="tracking-toggle">
                                        <label class="form-check-label me-3" for="trackingToggle">
                                            <span id="trackingStatus">Go Live</span>
                                        </label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="trackingToggle">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Controls (Only visible to admin) -->
                <div class="row mb-4" id="adminControls" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-users me-2"></i>
                                    User Management
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <select class="form-select" id="userSelect1">
                                                <option value="">Select a user to view history</option>
                                                <option th:each="username : ${wffEmployees}" th:value="${username}" th:text="${username}">
                                                </option>
                                            </select>
                                            <button class="btn btn-primary" id="viewUserHistoryBtn">
                                                <i class="fas fa-history me-2"></i>View History
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="mapView" id="liveView" value="live" checked>
                                            <label class="btn btn-outline-success" for="liveView">Live View</label>

                                            <input type="radio" class="btn-check" name="mapView" id="historyView" value="history">
                                            <label class="btn btn-outline-info" for="historyView">History View</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Status Cards (Admin View) -->
                <div class="row mb-4" id="userStatusCards" style="display: none;">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-success">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="activeUsers">0</h3>
                                <p>Active Users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-secondary">
                                <i class="fas fa-user-times"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="offlineUsers">0</h3>
                                <p>Offline Users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-info">
                                <i class="fas fa-route"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="totalDistance">0 km</h3>
                                <p>Total Distance</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon bg-warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="activeTime">0h</h3>
                                <p>Active Time</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map Container -->
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-map me-2"></i>
                                        <span id="mapTitle">Live Location Map</span>
                                    </h5>
                                    <div class="map-controls">
                                        <button class="btn btn-sm btn-outline-secondary me-2" id="centerMapBtn">
                                            <i class="fas fa-crosshairs me-1"></i>Center
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" id="refreshMapBtn">
                                            <i class="fas fa-sync-alt me-1"></i>Refresh
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="map" style="height: 500px; width: 100%;">
                                    <!-- Google Map will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <!-- Live Users Panel (Admin) -->
                        <div class="card" id="liveUsersPanel" style="display: none;">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-users me-2"></i>
                                    Live Users
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="liveUsersList" class="live-users-list">
                                    <!-- Live users will be displayed here -->
                                </div>
                            </div>
                        </div>

                        <!-- Personal Tracking Panel (User) -->
                        <div class="card" id="personalTrackingPanel" style="display: none;">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-user me-2"></i>
                                    My Tracking
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="tracking-info">
                                    <div class="info-item">
                                        <label>Status:</label>
                                        <span id="myTrackingStatus" class="badge bg-secondary">Offline</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Session Duration:</label>
                                        <span id="sessionDuration">00:00:00</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Distance Traveled:</label>
                                        <span id="distanceTraveled">0.0 km</span>
                                    </div>
                                    <div class="info-item">
                                        <label>Current Location:</label>
                                        <span id="currentLocation">Not available</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="tracking-history">
                                    <h6>Recent Sessions</h6>
                                    <div id="recentSessions">
                                        <!-- Recent tracking sessions -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location History Panel -->
                        <div class="card" id="locationHistoryPanel">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-history me-2"></i>
                                    Location History
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="history-filters mb-3">
                                    <select class="form-select form-select-sm" id="historyTimeFilter">
                                        <option value="24h">Last 24 Hours</option>
                                        <option value="7d">Last 7 Days</option>
                                        <option value="30d">Last 30 Days</option>
                                    </select>
                                </div>
                                <div id="locationHistoryList" class="location-history-list">
                                    <!-- Location history will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    </main>

    <!-- Location Detail Modal -->
    <div class="modal fade" id="locationDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Location Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="locationDetailContent">
                        <!-- Location details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkyZ_KEJyO9abb8-TW96HaE-Uu_3q4IQw&callback=initMap" async defer></script>
    <!-- Common JS -->
    <script th:src="@{/js/common.js}"></script>
    <!-- Mock Data -->
    <script th:src="@{/js/mock.js}"></script>
    <!-- Location Tracking JS -->
    <script th:src="@{/js/location-tracking.js}"></script>
</body>
</html>