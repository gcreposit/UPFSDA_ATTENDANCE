<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: head}">
    <title>Admin Dashboard - UPFSDA Attendance System</title>

    <!-- Include DataTables CSS -->
    <link th:href="@{/webjars/datatables/1.13.6/css/jquery.dataTables.min.css}" rel="stylesheet"/>
    <!-- If you want responsive -->
    <link th:href="@{/webjars/datatables-responsive/2.5.0/css/responsive.dataTables.min.css}" rel="stylesheet"/>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 16px;
        }
        @media (min-width: 640px){ .stats-grid{ grid-template-columns: repeat(2, 1fr);} }
        @media (min-width: 1024px){ .stats-grid{ grid-template-columns: repeat(3, 1fr);} }

        .stat-card{
            position: relative;
            border-radius: 16px;
            padding: 18px 18px 18px 72px;
            background: linear-gradient(180deg, #ffffff, #fafafa);
            box-shadow: 0 8px 24px rgba(16,24,40,0.06), 0 2px 8px rgba(16,24,40,0.04);
            transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
            cursor: pointer;
            overflow: hidden;
            min-height: 96px;
        }
        .stat-card:hover{
            transform: translateY(-3px);
            box-shadow: 0 16px 32px rgba(16,24,40,0.10), 0 4px 12px rgba(16,24,40,0.06);
            background: linear-gradient(180deg, #ffffff, #f7f7f7);
        }
        .stat-icon{
            position: absolute;
            left: 16px; top: 50%; transform: translateY(-50%);
            width: 44px; height: 44px; display:flex; align-items:center; justify-content:center;
            border-radius: 12px; background: #f3f4f6;
        }
        .stat-title{
            font-weight: 600; color: #344054; font-size: 14px; letter-spacing: .2px;
        }
        .stat-value{
            font-size: 28px; font-weight: 700; color: #0f172a; line-height: 1.2;
        }
        .stat-chip{
            display:inline-flex; align-items:center; gap:6px;
            font-size: 12px; padding: 4px 8px; border-radius: 9999px; background: #f1f5f9; color:#334155;
        }
        /* Category accents */
        .accent-on_time .stat-icon{ background:#e6f9ef; }
        .accent-on_time .stat-icon i{ color:#10b981; }
        .accent-late_entry .stat-icon{ background:#fff4e5; }
        .accent-late_entry .stat-icon i{ color:#f59e0b; }
        .accent-late_and_half .stat-icon{ background:#fef3f2; }
        .accent-late_and_half .stat-icon i{ color:#f97316; }
        .accent-half_day .stat-icon{ background:#fff1f2; }
        .accent-half_day .stat-icon i{ color:#ec4899; }
        .accent-absent .stat-icon{ background:#fef2f2; }
        .accent-absent .stat-icon i{ color:#ef4444; }
        .accent-wfh .stat-icon{ background:#eef2ff; }
        .accent-wfh .stat-icon i{ color:#6366f1; }
        .accent-wfo .stat-icon{ background:#e0f2fe; }
        .accent-wfo .stat-icon i{ color:#0ea5e9; }
        .accent-wff .stat-icon{ background:#ecfeff; }
        .accent-wff .stat-icon i{ color:#06b6d4; }
        .accent-total .stat-icon{ background:#f1f5f9; }
        .accent-total .stat-icon i{ color:#334155; }

        .stat-footer{
            margin-top: 8px; display:flex; align-items:center; justify-content:space-between;
        }
        .stat-link{ color:#2563eb; font-size:13px; text-decoration:none; }
        .stat-link:hover{ text-decoration: underline; }

        /* Skeletons */
        .skeleton{ background: linear-gradient(90deg, #f4f4f5 25%, #eceef1 37%, #f4f4f5 63%); background-size: 400% 100%; animation: shimmer 1.4s infinite; min-height: 96px; border-radius:16px; }
        @keyframes shimmer{ 0%{ background-position: 100% 0; } 100%{ background-position: -100% 0; } }

        .stats-error{ display:flex; align-items:center; gap:8px; padding:12px 14px; border-radius:12px; background:#fff1f2; color:#b91c1c; margin-top:12px; }
    </style>

</head>

<body>
<nav th:replace="~{fragments/layout :: sidebar}"></nav>
<header th:replace="~{fragments/layout :: header}"></header>

<main class="main-content">
    <div class="dashboard-grid-admin">
        <div class="dashboard-center">
            <div class="welcome-card">
                <div class="welcome-content">
                    <h3 th:text="${username} + ' Monthly Attendance Report'">Monthly Attendance Report</h3>
                    <p th:text="'Overview for ' + ${#dates.format(#dates.createNow(), 'MMMM yyyy')}"></p>
                    <small th:text="'Generated on ' + ${#dates.format(#dates.createNow(), 'EEEE, MMMM dd, yyyy')}"></small>
                </div>
                <div class="welcome-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
            </div>

            <!-- Cards section (replaces the Table section) -->
            <div class="dashboard-main">
                <div class="bg-white rounded-xl shadow-lg p-4">
                    <div id="statsGrid" class="stats-grid">
                        <!-- Skeletons while loading -->
                        <div class="stat-card skeleton"></div>
                        <div class="stat-card skeleton"></div>
                        <div class="stat-card skeleton"></div>
                        <div class="stat-card skeleton"></div>
                        <div class="stat-card skeleton"></div>
                        <div class="stat-card skeleton"></div>
                        <div class="stat-card skeleton"></div>
                        <div class="stat-card skeleton"></div>
                        <div class="stat-card skeleton"></div>
                    </div>
                    <div id="statsError" class="stats-error" hidden>
                        <i class="fas fa-triangle-exclamation"></i>
                        <span>Couldn’t load the monthly report. Please try again.</span>
                    </div>
                </div>
            </div>

        </div>

        <div class="dashboard-right">
            <div class="simple-calendar-card">
                <div class="simple-calendar-header">
                    <button class="simple-nav" id="simplePrevMonth"><i class="fas fa-chevron-left"></i></button>
                    <span class="simple-month-year" id="simpleCurrentMonth">August 2025</span>
                    <button class="simple-nav" id="simpleNextMonth"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="simple-calendar-grid" id="simpleCalendarGrid"></div>
            </div>
        </div>
    </div>
</main>


<footer th:replace="~{fragments/layout :: footer}"></footer>
<div th:replace="~{fragments/layout :: scripts}"></div>

<script th:inline="none">
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username') || /*[[${username}]]*/ '';
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;

        const grid = document.getElementById('statsGrid');
        const errBox = document.getElementById('statsError');

        function cardConfig(d) {
            // map data keys to pretty labels, icons, and category slugs for linking
            return [
                { key: 'total_days_in_month',    label: 'Total Days',        icon: 'fa-solid fa-calendar-days',  slug: null,           accent: 'total',     hint: 'Calendar days in month' },
                { key: 'working_days_in_month',  label: 'Working Days',      icon: 'fa-solid fa-briefcase',      slug: null,           accent: 'working',   hint: 'Excludes Sundays/holidays' },
                { key: 'holidays',               label: 'Holidays',          icon: 'fa-solid fa-umbrella-beach', slug: 'holiday',      accent: 'holiday',   hint: 'Weekly offs (Sundays) / holidays' },
                { key: 'present',                label: 'Present Days',      icon: 'fa-solid fa-user-check',     slug: 'present',      accent: 'present',   hint: 'Days employee was present' },
                { key: 'on_time',                label: 'On Time',           icon: 'fa-regular fa-clock',        slug: 'on_time',      accent: 'on_time',   hint: 'Arrived on or before start time' },
                { key: 'late_entry',             label: 'Late Entry',        icon: 'fa-solid fa-person-walking', slug: 'late_entry',   accent: 'late_entry',hint: 'Late arrivals without half day' },
                { key: 'late_and_half',          label: 'Late & Half',       icon: 'fa-solid fa-person-running', slug: 'late_and_half',accent: 'late_and_half',hint: 'Late arrivals counted as half day' },
                { key: 'half_day',               label: 'Half Day',          icon: 'fa-solid fa-hourglass-half', slug: 'half_day',     accent: 'half_day',  hint: 'Approved or computed half days' },
                { key: 'absent',                 label: 'Absent',            icon: 'fa-solid fa-user-xmark',     slug: 'absent',       accent: 'absent',    hint: 'Unapproved or marked absences' },
                { key: 'total_work_from_home',   label: 'Work From Home',    icon: 'fa-solid fa-house-laptop',   slug: 'wfh',          accent: 'wfh',       hint: 'WFH days logged' },
                { key: 'total_work_from_office', label: 'Work From Office',  icon: 'fa-solid fa-building',       slug: 'wfo',          accent: 'wfo',       hint: 'Office presence days' },
                { key: 'total_work_from_field',  label: 'Work From Field',   icon: 'fa-solid fa-map-location',   slug: 'wff',          accent: 'wff',       hint: 'On-field work days' }
            ];
        }

        function linkFor(slug){
            if(!slug) return null;
            const params = new URLSearchParams({
                username: username || '',
                year, month, category: slug
            });
            return `/attendance/monthly/details?${params.toString()}`;
        }

        function createCard({label, value, icon, slug, accent, hint}){
            const aHref = linkFor(slug);
            const wrapper = document.createElement(aHref ? 'a' : 'div');
            if (aHref) { wrapper.href = aHref; wrapper.className = 'stat-link-wrap'; }
            const card = document.createElement('div');
            card.className = `stat-card accent-${accent}`;
            card.setAttribute('title', hint || label);

            const iconBox = document.createElement('div');
            iconBox.className = 'stat-icon';
            iconBox.innerHTML = `<i class="${icon}"></i>`;

            const title = document.createElement('div');
            title.className = 'stat-title';
            title.textContent = label;
            title.style.setProperty('color', 'black', 'important');

            const valueEl = document.createElement('div');
            valueEl.className = 'stat-value';
            valueEl.textContent = value ?? 0;
            valueEl.style.setProperty('color', 'black', 'important');

            const footer = document.createElement('div');
            footer.className = 'stat-footer';

            // const chip = document.createElement('div');
            // chip.className = 'stat-chip';
            // chip.innerHTML = '<i class="fa-solid fa-arrow-up-right-from-square"></i> Details';
            //
            // const link = document.createElement('span');
            // link.className = 'stat-link';
            // link.textContent = aHref ? 'View details' : '—';
            //
            // footer.appendChild(chip);
            // footer.appendChild(link);

            card.appendChild(iconBox);
            card.appendChild(title);
            card.appendChild(valueEl);
            card.appendChild(footer);

            wrapper.appendChild(card);
            return wrapper;
        }

        function renderCards(d){
            grid.innerHTML = '';
            const items = cardConfig(d).map(cfg => {
                const value = d[cfg.key];
                return createCard({ ...cfg, value });
            });
            items.forEach(el => grid.appendChild(el));
        }

        // Fetch data
        const formData = new URLSearchParams();
        if (username) formData.append('username', username);
        formData.append('year', year);
        formData.append('month', month);

        fetch('/api/data/dashboard/monthly', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: formData.toString()
        })
            .then(res => res.json())
            .then(data => {
                if (data.flag === 'success') {
                    renderCards(data.data || {});
                } else {
                    errBox.hidden = false;
                    console.error('API error:', data.message);
                }
            })
            .catch(err => {
                errBox.hidden = false;
                console.error('Error:', err);
            });

        // Keep your simple calendar behavior as-is below (if any extra scripting lives elsewhere)
    });
</script>

</body>
</html>
