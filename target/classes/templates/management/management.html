<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}">
    <title>Work Types Management - UPFSDA Attendance System</title>
</head>

<body>
<nav th:replace="~{fragments/layout :: sidebar}"></nav>
<header th:replace="~{fragments/layout :: header}"></header>

<main class="main-content">
    <div class="dashboard-grid-admin">
        <div class="dashboard-center">

            <!-- Add Work Type Form -->
            <div class="card">
                <h5><i class="fas fa-briefcase mb-2"></i> Manage Work Types</h5>
                <form th:action="@{/attendance/management/work-types/add}" method="post" class="form-inline">
                    <input type="text" name="workType" class="form-control" placeholder="Enter new work type" required>
                    <button type="submit" class="btn btn-primary mt-2">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </form>
            </div>

            <!-- Work Types Table -->
            <div class="card">
                <h5><i class="fas fa-list mb-3"></i> Existing Work Types</h5>
                <table id="workTypesTable" class="table table-bordered display nowrap" style="width:100%">
                    <thead>
                    <tr>
                        <th hidden>ID</th>
                        <th>Work Type</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="workType : ${workTypes}">
                        <td hidden th:text="${workType.id}"></td>
                        <td th:text="${workType.workType}"></td>
                        <td>
                            <div style="display:inline-flex; gap:6px; align-items:center;">
                                <!-- Edit button opens modal -->
                                <button type="button" class="btn btn-warning btn-sm"
                                        data-bs-toggle="modal"
                                        th:attr="data-bs-target='#editModal_' + ${workType.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>

                                <!-- Delete button -->
                                <form th:action="@{/attendance/management/work-types/delete/{id}(id=${workType.id})}"
                                      method="post" th:onsubmit="return confirm('Are you sure?')"
                                      style="margin:0;">
                                    <button type="submit" class="btn btn-danger btn-sm">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </td>

                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="dashboard-right">
                    <h5 class="mb-3"><i class="fas fa-calendar-alt"></i> Holiday Maintenance</h5>
                    <div class="simple-calendar-card">
                        <div class="simple-calendar-header">
                            <button class="simple-nav" id="simplePrevMonth"><i class="fas fa-chevron-left"></i></button>
                            <span class="simple-month-year" id="simpleCurrentMonth">August 2025</span>
                            <button class="simple-nav" id="simpleNextMonth"><i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="simple-calendar-grid" id="simpleCalendarGrid"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</main>

<!--Modal For Work Type Update-->
<div th:each="workType : ${workTypes}">
    <div class="modal fade" th:id="'editModal_' + ${workType.id}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/attendance/management/work-types/edit/{id}(id=${workType.id})}" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Work Type</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" name="workType" th:value="${workType.workType}" class="form-control"
                               required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Holiday Modal -->
<!--<div class="modal fade" id="holidayModal" tabindex="-1" aria-hidden="true">-->
<!--    <div class="modal-dialog">-->
<!--        <form id="holidayForm" class="modal-content">-->
<!--            <div class="modal-header">-->
<!--                <h5 class="modal-title">Add Holiday</h5>-->
<!--                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>-->
<!--            </div>-->

<!--            <div class="modal-body">-->
<!--                <div class="mb-3">-->
<!--                    <label for="holiday_date" class="form-label">Date</label>-->
<!--                    <input type="text" class="form-control" id="holiday_date" name="holiday_date" readonly>-->
<!--                </div>-->

<!--                <div class="mb-3">-->
<!--                    <label for="name" class="form-label">Holiday Name</label>-->
<!--                    <input type="text" class="form-control" id="name" name="name" required>-->
<!--                </div>-->

<!--                <div class="mb-3">-->
<!--                    <label for="description" class="form-label">Description</label>-->
<!--                    <textarea class="form-control" id="description" name="description"></textarea>-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="modal-footer">-->
<!--                <button type="submit" class="btn btn-primary">Save Holiday</button>-->
<!--                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>-->
<!--            </div>-->
<!--        </form>-->
<!--    </div>-->
<!--</div>-->


<div class="modal fade" id="holidayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="holidayModalTitle">Add Holiday</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="holidayForm">
                <div class="modal-body">
                    <input type="date" id="holiday_date" class="form-control mb-2" required>
                    <input type="text" id="name" class="form-control mb-2" placeholder="Holiday Name" required>
                    <textarea id="description" class="form-control" placeholder="Description"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" id="deleteHolidayBtn" class="btn btn-danger" style="display:none;">Delete
                    </button>
                    <button type="submit" id="saveHolidayBtn" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>


<footer th:replace="~{fragments/layout :: footer}"></footer>
<div th:replace="~{fragments/layout :: scripts}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // Thymeleaf injects holidays as JSON from backend
    const holidaysFromServer = /*[[${holidays}]]*/ [];
    /*]]>*/
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        initializeCalendar();
    });

    function initializeCalendar() {
        const currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        // Expose render function so we can call it after saving
        window.renderSimpleCalendar = renderSimpleCalendar;

        document.getElementById('simplePrevMonth').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderSimpleCalendar();
        });

        document.getElementById('simpleNextMonth').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderSimpleCalendar();
        });

        function renderSimpleCalendar() {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];

            document.getElementById('simpleCurrentMonth').textContent =
                `${monthNames[currentMonth]} ${currentYear}`;
            const calendarGrid = document.getElementById('simpleCalendarGrid');

            calendarGrid.innerHTML = '';

            // ✅ Weekday headers
            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'simple-weekday';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            });

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Empty cells for offset
            for (let i = 0; i < firstDay; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'simple-day other-month';
                calendarGrid.appendChild(dayElement);
            }

            // Inside renderSimpleCalendar(), replace the actual days loop:
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayElement = document.createElement('div');
                dayElement.className = 'simple-day';
                dayElement.style.display = "flex";
                dayElement.style.flexDirection = "column";   // stack vertically
                dayElement.style.alignItems = "center";      // center align text

                // Day number (always shown)
                const dayNumber = document.createElement("div");
                dayNumber.textContent = day;
                dayNumber.style.fontWeight = "bold";
                dayNumber.style.fontSize = "14px";
                dayElement.appendChild(dayNumber);

                // Highlight today
                if (
                    currentYear === new Date().getFullYear() &&
                    currentMonth === new Date().getMonth() &&
                    day === new Date().getDate()
                ) {
                    dayElement.style.border = "2px solid blue";
                }

                // ✅ Check if holiday
                const holiday = holidaysFromServer.find(h => h.holidayDate === dateStr);
                if (holiday) {
                    const holidayLabel = document.createElement("div");
                    holidayLabel.textContent = holiday.name;
                    holidayLabel.style.fontSize = "13px";   // bigger text
                    holidayLabel.style.fontWeight = "600";  // semi-bold
                    holidayLabel.style.marginTop = "4px";
                    holidayLabel.style.textAlign = "center";
                    holidayLabel.style.whiteSpace = "normal";   // allow wrapping
                    holidayLabel.style.lineHeight = "1.2";      // compact spacing
                    holidayLabel.title = holiday.description || holiday.name;

                    dayElement.appendChild(holidayLabel);

                    dayElement.style.backgroundColor = "lightcoral";
                    dayElement.style.color = "white";
                    dayElement.style.borderRadius = "4px";
                    dayElement.style.padding = "2px";
                }

                // Sunday handling
                const weekDay = new Date(currentYear, currentMonth, day).getDay();
                if (weekDay === 0) {
                    dayElement.style.backgroundColor = "lightgray";
                    dayElement.style.color = "darkred";
                    dayElement.style.cursor = "not-allowed";
                } else {
                    dayElement.style.cursor = "pointer";
                    dayElement.addEventListener("click", function () {
                        const existingHoliday = holidaysFromServer.find(h => h.holidayDate === dateStr);

                        if (existingHoliday) {
                            // Prefill fields
                            document.getElementById("holiday_date").value = existingHoliday.holidayDate;
                            document.getElementById("holiday_date").readOnly = true;
                            document.getElementById("name").value = existingHoliday.name;
                            document.getElementById("description").value = existingHoliday.description || "";

                            // Change modal UI
                            document.getElementById("holidayModalTitle").textContent = "View / Update Holiday";
                            document.getElementById("saveHolidayBtn").textContent = "Update";
                            document.getElementById("deleteHolidayBtn").style.display = "inline-block";

                            // Attach delete action
                            document.getElementById("deleteHolidayBtn").onclick = function () {
                                if (confirm("Are you sure you want to delete this holiday?")) {
                                    fetch(`/api/data/deleteHoliday/${existingHoliday.id}`, {
                                        method: "DELETE"
                                    })
                                        .then(res => {
                                            if (!res.ok) throw new Error("Failed to delete holiday");
                                            // Remove from local list
                                            const idx = holidaysFromServer.findIndex(h => h.id === existingHoliday.id);
                                            if (idx > -1) holidaysFromServer.splice(idx, 1);

                                            renderSimpleCalendar();
                                            bootstrap.Modal.getInstance(document.getElementById("holidayModal")).hide();
                                        })
                                        .catch(err => alert("Error deleting holiday: " + err));
                                }
                            };

                        } else {
                            // Empty form
                            document.getElementById("holiday_date").value = dateStr;
                            document.getElementById("holiday_date").readOnly = false;
                            document.getElementById("name").value = "";
                            document.getElementById("description").value = "";

                            // Change modal UI
                            document.getElementById("holidayModalTitle").textContent = "Add Holiday";
                            document.getElementById("saveHolidayBtn").textContent = "Save";
                            document.getElementById("deleteHolidayBtn").style.display = "none";
                        }

                        new bootstrap.Modal(document.getElementById("holidayModal")).show();
                    });

                }

                calendarGrid.appendChild(dayElement);
            }

        }

        // First render
        renderSimpleCalendar();

        document.getElementById("holidayForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const holiday = {
                holidayDate: document.getElementById("holiday_date").value,
                name: document.getElementById("name").value,
                description: document.getElementById("description").value
            };

            const existingHoliday = holidaysFromServer.find(h => h.holidayDate === holiday.holidayDate);

            let url = "/api/data/createHolidays";
            let method = "POST";

            if (existingHoliday) {
                url = `/api/data/updateHoliday/${existingHoliday.id}`;
                method = "PUT";
                holiday.id = existingHoliday.id;
            }

            fetch(url, {
                method: method,
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(holiday)
            })
                .then(response => {
                    if (!response.ok) throw new Error("Failed to save holiday");
                    return response.json();
                })
                .then(data => {
                    if (existingHoliday) {
                        // update local record
                        const idx = holidaysFromServer.findIndex(h => h.id === data.id);
                        holidaysFromServer[idx] = data;
                        alert("Holiday updated: " + data.name);
                    } else {
                        holidaysFromServer.push(data);
                        alert("Holiday saved: " + data.name);
                    }

                    renderSimpleCalendar();
                    bootstrap.Modal.getInstance(document.getElementById("holidayModal")).hide();
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Error saving holiday. Please try again.");
                });
        });
    }
</script>

</body>
</html>
