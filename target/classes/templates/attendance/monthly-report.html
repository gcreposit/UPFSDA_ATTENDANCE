<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: head}">
    <title>Admin Dashboard - UPFSDA Attendance System</title>

    <!-- Include DataTables CSS -->
    <link th:href="@{/webjars/datatables/1.13.6/css/jquery.dataTables.min.css}" rel="stylesheet"/>
    <!-- If you want responsive -->
    <link th:href="@{/webjars/datatables-responsive/2.5.0/css/responsive.dataTables.min.css}" rel="stylesheet"/>
</head>

<body>
<nav th:replace="~{fragments/layout :: sidebar}"></nav>
<header th:replace="~{fragments/layout :: header}"></header>

<main class="main-content">
    <div class="dashboard-grid-admin">
        <div class="dashboard-center">
            <div class="welcome-card">
                <div class="welcome-content">
                    <h3 th:text="${username} + ' Monthly Attendance Report'">Monthly Attendance Report</h3>
                    <p th:text="'Overview for ' + ${#dates.format(#dates.createNow(), 'MMMM yyyy')}"></p>
                    <small th:text="'Generated on ' + ${#dates.format(#dates.createNow(), 'EEEE, MMMM dd, yyyy')}"></small>
                </div>
                <div class="welcome-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
            </div>

            <!-- Table section -->
            <div class="dashboard-main">
                <div class="bg-white rounded-xl shadow-lg p-2">
                    <!-- Employee Table -->
                    <div class="table-responsive">
                        <table id="reportTable" class="table table-bordered display nowrap" style="width:100%">
                            <thead>
                            <tr>
                                <th>On Time</th>
                                <th>Late Entry</th>
                                <th>Late & Half</th>
                                <th>Half Day</th>
                                <th>Absent</th>
                                <th>Work From Home</th>
                                <th>Work From Office</th>
                                <th>Work From Field</th>
                                <th>Total Days</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-right">
            <div class="simple-calendar-card">
                <div class="simple-calendar-header">
                    <button class="simple-nav" id="simplePrevMonth"><i class="fas fa-chevron-left"></i></button>
                    <span class="simple-month-year" id="simpleCurrentMonth">August 2025</span>
                    <button class="simple-nav" id="simpleNextMonth"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="simple-calendar-grid" id="simpleCalendarGrid"></div>
            </div>
        </div>
    </div>
</main>


<footer th:replace="~{fragments/layout :: footer}"></footer>
<div th:replace="~{fragments/layout :: scripts}"></div>

<script th:inline="none">
    document.addEventListener('DOMContentLoaded', function () {
        const path = window.location.pathname;
        const pathParts = path.split('/');
        const username = pathParts[pathParts.length - 1];

        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;

        const formData = new URLSearchParams();
        formData.append('username', username);
        formData.append('year', year);
        formData.append('month', month);

        fetch('/api/data/dashboard/monthly', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: formData.toString()
        })
            .then(res => res.json())
            .then(data => {
                if (data.flag === 'success') {
                    const d = data.data;

                    // Function to create hyperlink for each category
                    function linkify(value, category) {
                        return `<a href="/attendance/monthly/details?username=${encodeURIComponent(username)}&year=${year}&month=${month}&category=${encodeURIComponent(category)}">${value}</a>`;
                    }

                    $('#reportTable').DataTable({
                        data: [[
                            linkify(d.on_time, 'on_time'),
                            linkify(d.late_entry, 'late_entry'),
                            linkify(d.late_and_half, 'late_and_half'),
                            linkify(d.half_day, 'half_day'),
                            linkify(d.absent, 'absent'),
                            linkify(d.total_work_from_home, 'wfh'),
                            linkify(d.total_work_from_office, 'wfo'),
                            linkify(d.total_work_from_field, 'wff'),
                            d.total_days_in_month // total days probably doesn't need a link
                        ]],
                        columnDefs: [
                            {targets: '_all', className: 'text-center'}
                        ]
                    });
                } else {
                    alert(data.message);
                }
            })
            .catch(err => console.error('Error:', err));
    });
</script>

</body>
</html>
