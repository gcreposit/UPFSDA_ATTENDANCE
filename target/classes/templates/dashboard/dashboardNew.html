<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/layout :: head}">
    <title>Admin Dashboard - UPFSDA Attendance System</title>

</head>

<body>
<nav th:replace="~{fragments/layout :: sidebar}"></nav>
<header th:replace="~{fragments/layout :: header}"></header>

<main class="main-content">
    <div class="dashboard-grid-admin">

        <div class="dashboard-center">
            <div class="welcome-card">
                <div class="welcome-content">
                    <h3>Admin Dashboard</h3>
                    <p>Here's the attendance overview for today.</p>
                    <small th:text="'Today is ' + ${#dates.format(#dates.createNow(), 'EEEE, MMMM dd, yyyy')}"></small>
                </div>
                <div class="welcome-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>

            <div class="dashboard-main">
<!--                &lt;!&ndash; Summary Cards Section &ndash;&gt;-->
<!--                <div class="stats-section">-->

<!--                    &lt;!&ndash; Total Employees &ndash;&gt;-->
<!--                    <div class="stat-card-small" onclick="goToDetails('total_employees')">-->
<!--                        <div class="stat-icon" style="background:#007bff"><i class="fas fa-users"></i></div>-->
<!--                        <div class="stat-content">-->
<!--                            <div class="stat-title">Total Employees</div>-->
<!--                            <div class="stat-value" id="totalEmployeesCount">0</div>-->
<!--                        </div>-->
<!--                    </div>-->

<!--                    &lt;!&ndash; Present Card with Breakdown Inside &ndash;&gt;-->
<!--                    <div class="stat-card-small" style="flex: 1;">-->
<!--                        <div class="stat-icon" style="background:#28a745"><i class="fas fa-user-check"></i></div>-->
<!--                        <div class="stat-content" style="width: 100%;">-->
<!--                            <div class="stat-title" onclick="goToDetails('today_present')" style="cursor: pointer;">Present</div>-->
<!--                            <div class="stat-value" id="presentCount" onclick="goToDetails('today_present')" style="cursor: pointer;">0</div>-->

<!--                            &lt;!&ndash; Attendance Type Breakdown &ndash;&gt;-->
<!--                            <div style="margin-top: 8px; font-size: 0.85rem; color: #555;">-->
<!--                                <strong>Attendance Type</strong>-->
<!--                                <div style="display: flex; justify-content: space-between; cursor: pointer;" onclick="goToDetails('on_time')">-->
<!--                                    <span>On Time:</span> <span id="onTimeCount">0</span>-->
<!--                                </div>-->
<!--                                <div style="display: flex; justify-content: space-between; cursor: pointer;" onclick="goToDetails('late_entry')">-->
<!--                                    <span>Late Entry:</span> <span id="lateEntryCount">0</span>-->
<!--                                </div>-->
<!--                                <div style="display: flex; justify-content: space-between; cursor: pointer;" onclick="goToDetails('late_and_half')">-->
<!--                                    <span>Late & Half Day:</span> <span id="lateAndHalfCount">0</span>-->
<!--                                </div>-->
<!--                            </div>-->

<!--                            &lt;!&ndash; Work Mode Breakdown &ndash;&gt;-->
<!--                            <div style="margin-top: 8px; font-size: 0.85rem; color: #555;">-->
<!--                                <strong>Work Mode</strong>-->
<!--                                <div style="display: flex; justify-content: space-between; cursor: pointer;" onclick="goToDetails('wfo')">-->
<!--                                    <span>Work From Office:</span> <span id="wfoCount">0</span>-->
<!--                                </div>-->
<!--                                <div style="display: flex; justify-content: space-between; cursor: pointer;" onclick="goToDetails('wfh')">-->
<!--                                    <span>Work From Home:</span> <span id="wfhCount">0</span>-->
<!--                                </div>-->
<!--                                <div style="display: flex; justify-content: space-between; cursor: pointer;" onclick="goToDetails('wff')">-->
<!--                                    <span>Work From Field:</span> <span id="wffCount">0</span>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->

<!--                    &lt;!&ndash; Absent &ndash;&gt;-->
<!--                    <div class="stat-card-small" onclick="goToDetails('absent')">-->
<!--                        <div class="stat-icon" style="background:#dc3545"><i class="fas fa-user-times"></i></div>-->
<!--                        <div class="stat-content">-->
<!--                            <div class="stat-title">Absent</div>-->
<!--                            <div class="stat-value" id="absentCount">0</div>-->
<!--                        </div>-->
<!--                    </div>-->

<!--                    &lt;!&ndash; Half Day &ndash;&gt;-->
<!--                    <div class="stat-card-small" onclick="goToDetails('half_day')">-->
<!--                        <div class="stat-icon" style="background-color: #ff9800;">-->
<!--                            <i class="fas fa-user-slash"></i>-->
<!--                        </div>-->
<!--                        <div class="stat-content">-->
<!--                            <div class="stat-title">Half Day</div>-->
<!--                            <div class="stat-value" id="halfDayCount">0</div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->


                <!-- Summary Cards Section -->
                <div class="stats-section">

                    <!-- Total Employees -->
                    <div class="stat-card-small" onclick="goToDetails('total_employees')" style="background: linear-gradient(145deg, #00b3b3, #009999)">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-content">
                            <div class="stat-title">Total Employees</div>
                            <div class="stat-value" id="totalEmployeesCount">0</div>
                        </div>
                    </div>

                    <!-- Present Card with Breakdown Inside -->
                    <div class="stat-card-large" style="background: linear-gradient(145deg, #28a745, #218838);" onclick="goToDetails('today_present')">
                        <div class="stat-icon"><i class="fas fa-user-check"></i></div>
                        <div class="stat-content">
                            <div class="stat-title">Present</div>
                            <div class="stat-value" id="presentCount">0</div>

                            <!-- Attendance Type Breakdown -->
                            <div class="stat-breakdown">
                                <strong>Attendance Type</strong>
                                <div class="breakdown-item" onclick="event.stopPropagation(); goToDetails('on_time')">
                                    <span>On Time:</span> <span id="onTimeCount">0</span>
                                </div>
                                <div class="breakdown-item" onclick="event.stopPropagation(); goToDetails('late_entry')">
                                    <span>Late Entry:</span> <span id="lateEntryCount">0</span>
                                </div>
                                <div class="breakdown-item" onclick="event.stopPropagation(); goToDetails('late_and_half')">
                                    <span>Late & Half Day:</span> <span id="lateAndHalfCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Work Mode Card -->
                    <div class="stat-card-large" style="background: linear-gradient(145deg, #3f51b5, #303f9f);">
                        <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                        <div class="stat-content">
                            <div class="stat-title">Work Mode</div>

                            <!-- Work Mode Breakdown -->
                            <div class="stat-breakdown">
                                <div class="breakdown-item" onclick="goToDetails('wfo')">
                                    <span>Work From Office:</span> <span id="wfoCount">0</span>
                                </div>
                                <div class="breakdown-item" onclick="goToDetails('wfh')">
                                    <span>Work From Home:</span> <span id="wfhCount">0</span>
                                </div>
                                <div class="breakdown-item" onclick="goToDetails('wff')">
                                    <span>Work From Field:</span> <span id="wffCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Absent -->
                    <div class="stat-card-small" onclick="goToDetails('absent')" style="background: linear-gradient(145deg, #ff4444, #d40000)">
                        <div class="stat-icon"><i class="fas fa-user-times"></i></div>
                        <div class="stat-content">
                            <div class="stat-title">Absent</div>
                            <div class="stat-value" id="absentCount">0</div>
                        </div>
                    </div>

                    <!-- Half-Day -->
                    <div class="stat-card-small" onclick="goToDetails('half_day')" style="background: linear-gradient(145deg, #ff9800, #e68900)">
                        <div class="stat-icon"><i class="fas fa-user-slash"></i></div>
                        <div class="stat-content">
                            <div class="stat-title">Half Day</div>
                            <div class="stat-value" id="halfDayCount">0</div>
                        </div>
                    </div>

                </div>

                <div style="display: flex !important; justify-content: space-around !important; align-content: center !important; width: 100% !important;">
                <!-- Chart Section -->
                <div class=" chart-section">
                    <h1 class="text-4xl md:text-5xl font-bold mb-2 text-indigo-700">Attendance Status Distribution</h1>
                    <canvas id="attendancePieChart" width="100" height="100"></canvas>
                </div>

                <div class=" w-full  text-gray-800 mt-4">
                    <div class="text-center mb-10">
                        <h1 class="text-4xl md:text-5xl font-bold mb-2 text-indigo-700">Today Attendance Trend</h1>
                        <p class="text-lg text-gray-600">Dynamic visualization for your attendance data.</p>
                    </div>

                    <div class="grid md:grid-cols-1 gap-8">
                        <!-- Weekly Line Chart Container -->
                        <div class="chart-container">
                            <div class="chart-wrapper">
                                <canvas id="weeklyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                </div>

            </div>

        </div>

        <div class="dashboard-right">
            <div class="simple-calendar-card">
                <div class="simple-calendar-header">
                    <button class="simple-nav" id="simplePrevMonth"><i class="fas fa-chevron-left"></i></button>
                    <span class="simple-month-year" id="simpleCurrentMonth">August 2025</span>
                    <button class="simple-nav" id="simpleNextMonth"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="simple-calendar-grid" id="simpleCalendarGrid"></div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>
<div th:replace="~{fragments/layout :: scripts}"></div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>


    // // Data for the weekly line chart
    // const weeklyData = {
    //     labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
    //     datasets: [{
    //         label: 'Present Students',
    //         data: [45, 48, 42, 49, 46],
    //         borderColor: '#3b82f6',
    //         backgroundColor: 'rgba(59, 130, 246, 0.2)',
    //         tension: 0.4,
    //         fill: true
    //     }, {
    //         label: 'Absent Students',
    //         data: [5, 2, 8, 1, 4],
    //         borderColor: '#f87171',
    //         backgroundColor: 'rgba(248, 113, 129, 0.2)',
    //         tension: 0.4,
    //         fill: true
    //     }]
    // };
    //
    // // Function to create a chart
    // function createChart(chartId, type, data) {
    //     const ctx = document.getElementById(chartId).getContext('2d');
    //     new Chart(ctx, {
    //         type: type,
    //         data: data,
    //         options: {
    //             responsive: true,
    //             maintainAspectRatio: false,
    //             plugins: {
    //                 legend: {
    //                     display: true,
    //                     position: 'bottom',
    //                     labels: { color: '#343a40' }
    //                 },
    //                 title: {
    //                     display: false,
    //                 }
    //             },
    //             scales: {
    //                 y: {
    //                     beginAtZero: true,
    //                     grid: { color: '#e0e0e0' }
    //                 },
    //                 x: {
    //                     grid: { color: '#e0e0e0' }
    //                 }
    //             }
    //         }
    //     });
    // }
    //
    // // Initialize charts on window load
    // window.onload = function() {
    //     createChart('weeklyChart', 'line', weeklyData);
    // };





    // Function to fetch the API data and update the chart
    async function fetchDataAndUpdateChart() {
        try {
            const response = await fetch('/api/data/dashboard-stats-admin');
            const data = await response.json();

            if (data.statusCode === 200) {
                // Use the 'present_today' and 'absent_today' values from the API to update the chart
                const presentToday = data.data.present_today;
                const absentToday = data.data.absent_today;

                // Create data for today's attendance trend
                const updatedTodayData = {
                    labels: ['Today'],  // Only show 'Today'
                    datasets: [{
                        label: 'Present Employee',
                        data: [presentToday],  // Only today’s data
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Absent Employee',
                        data: [absentToday],  // Only today’s data
                        borderColor: '#f87171',
                        backgroundColor: 'rgba(248, 113, 129, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                };

                // Now create or update the chart with today's data
                createChart('weeklyChart', 'line', updatedTodayData);
            } else {
                console.error('Error fetching data:', data.message);
            }
        } catch (error) {
            console.error('API call failed:', error);
        }
    }

    // Function to create a chart
    function createChart(chartId, type, data) {
        const ctx = document.getElementById(chartId).getContext('2d');
        new Chart(ctx, {
            type: type,
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: { color: '#343a40' }
                    },
                    title: {
                        display: true,
                        text: 'Today Attendance Trend',  // Set the title
                        font: { size: 18 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#e0e0e0' }
                    },
                    x: {
                        grid: { color: '#e0e0e0' }
                    }
                }
            }
        });
    }

    // Initialize charts on window load
    window.onload = function() {
        fetchDataAndUpdateChart(); // Fetch the data and update the chart on page load
    };



    document.addEventListener('DOMContentLoaded', function () {
        loadAdminDashboardData();
        initializeCalendar();
    });

    function goToDetails(type) {

        window.location.href = `/attendance/attendance-details?type=${type}`;

    }

    let attendancePieChart = null; // store chart instance

    async function loadAdminDashboardData() {
        try {
            const response = await fetch('/api/data/dashboard-stats-admin');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const apiResponse = await response.json();
            console.log(apiResponse , "llll")

            if (apiResponse.statusCode === 200 && apiResponse.data) {
                updateDashboardStats(apiResponse.data);
            } else {
                console.warn('API returned no data:', apiResponse.message);
            }
        } catch (error) {
            console.error('Error loading admin dashboard data:', error);
            // alert('Failed to load dashboard data. Please try again later.');
        }
    }

    function updateDashboardStats(data) {
        document.getElementById('totalEmployeesCount').textContent = data.total_employees || 0;
        document.getElementById('onTimeCount').textContent = data.on_time || 0;
        document.getElementById('lateEntryCount').textContent = data.late_entry || 0;
        document.getElementById('absentCount').textContent = data.absent_today || 0;
        document.getElementById('halfDayCount').textContent = data.half_day || 0;
        document.getElementById('lateAndHalfCount').textContent = data.late_and_half || 0;
        document.getElementById('wfoCount').textContent = data.total_work_from_office || 0;
        document.getElementById('wfhCount').textContent = data.total_work_from_home || 0;
        document.getElementById('wffCount').textContent = data.total_work_from_field || 0;
        document.getElementById('presentCount').textContent = data.present_today || 0;

        // Prepare pie chart data
        const chartData = [
            data.on_time || 0,
            data.late_entry || 0,
            data.absent_today || 0,
            data.half_day || 0,
            data.late_and_half || 0
        ];

        const chartLabels = ['On Time', 'Late Entry', 'Absent', 'Half Day', 'Late & Half Day'];
        const chartColors = ['#4caf50', '#ff9800', '#f44336', '#2196f3', '#9c27b0'];

        // Destroy previous chart instance if exists
        if (attendancePieChart) attendancePieChart.destroy();

        // Create chart
        const ctx = document.getElementById('attendancePieChart').getContext('2d');
        attendancePieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Attendance Overview',
                    data: chartData,
                    backgroundColor: chartColors,
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {position: 'bottom'},
                    tooltip: {enabled: true}
                }
            }
        });
    }

    function initializeCalendar() {
        const currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        document.getElementById('simplePrevMonth').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderSimpleCalendar();
        });

        document.getElementById('simpleNextMonth').addEventListener('click', () => {
            console.log("Clicked")
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderSimpleCalendar();

        });

        // function renderSimpleCalendar() {
        //     console.log('clicked 1')
        //     const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        //         'July', 'August', 'September', 'October', 'November', 'December'];
        //     const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        //
        //     document.getElementById('simpleCurrentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
        //     const calendarGrid = document.getElementById('simpleCalendarGrid');
        //
        //     calendarGrid.innerHTML = '';
        //
        //     weekdays.forEach(day => {
        //         const dayElement = document.createElement('div');
        //         dayElement.className = 'simple-weekday';
        //         dayElement.textContent = day;
        //         calendarGrid.appendChild(dayElement);
        //     });
        //
        //     const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        //     const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        //
        //     for (let i = 0; i < firstDay; i++) {
        //         const dayElement = document.createElement('div');
        //         dayElement.className = 'simple-day other-month';
        //         calendarGrid.appendChild(dayElement);
        //     }
        //
        //     for (let day = 1; day <= daysInMonth; day++) {
        //         const dayElement = document.createElement('div');
        //         dayElement.className = 'simple-day';
        //         dayElement.textContent = day;
        //         if (currentYear === currentDate.getFullYear() &&
        //             currentMonth === currentDate.getMonth() &&
        //             day === currentDate.getDate()) {
        //             dayElement.classList.add('today');
        //         }
        //         calendarGrid.appendChild(dayElement);
        //     }
        // }

        function renderSimpleCalendar() {
            console.log('clicked 1');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            const weekdays = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];

            document.getElementById('simpleCurrentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            const calendarGrid = document.getElementById('simpleCalendarGrid');

            calendarGrid.innerHTML = '';

            weekdays.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'simple-weekday';
                dayElement.textContent = day;
                calendarGrid.appendChild(dayElement);
            });

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Add empty days before the 1st day of the current month
            for (let i = 0; i < firstDay; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'simple-day other-month';
                calendarGrid.appendChild(dayElement);
            }


            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'simple-day';
                dayElement.textContent = day;

                // Highlight today if the day matches
                if (currentYear === currentDate.getFullYear() &&
                    currentMonth === currentDate.getMonth() &&
                    day === currentDate.getDate()) {
                    dayElement.classList.add('today');
                }

                // Add event listener to show popup when day is clicked
                dayElement.addEventListener('click', function () {
                    console.log(`Day ${day} clicked`);  // Check if this log appears
                    showPopup(day);  // Show popup with the clicked day
                });

                // Add the day element to the calendar grid
                calendarGrid.appendChild(dayElement);
            }

        }

        function showPopup(day) {
            // Get current date to match with clicked day
            const currentDate = new Date();
            const currentDay = currentDate.getDate();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();

            // If it's not today's day, do not show popup
            if (day !== currentDay || currentMonth !== currentDate.getMonth() || currentYear !== currentDate.getFullYear()) {
                console.log('Popup not displayed for this day.');
                return;
            }

            // Create the popup element
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
        <div class="popup-header">
            <h2><i class="fas fa-calendar-day"></i> Dashboard Overview - ${day}</h2>
            <p id="popup-date">${currentDate.toDateString()}</p>
        </div>
        <div class="popup-content">
            <p><i class="fas fa-user-times"></i> <strong>Absent Today:</strong> <span id="absent-today">Loading...</span></p>
            <p><i class="fas fa-check-circle"></i> <strong>Present Today:</strong> <span id="present-today">Loading...</span></p>
            <p><i class="fas fa-users"></i> <strong>Total Employees:</strong> <span id="total-employees">Loading...</span></p>
            <p><i class="fas fa-briefcase"></i> <strong>Work From Office:</strong> <span id="work-from-office">Loading...</span></p>
            <p><i class="fas fa-home"></i> <strong>Work From Home:</strong> <span id="work-from-home">Loading...</span></p>
            <p><i class="fas fa-map-marker-alt"></i> <strong>Work From Field:</strong> <span id="work-from-field">Loading...</span></p>
        </div>
        <div class="popup-footer">
            <button class="close-popup"><i class="fas fa-times"></i> Close</button>
        </div>
    `;

            // Create overlay for background
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';

            // Append the popup and overlay to the body
            document.body.appendChild(overlay);
            document.body.appendChild(popup);

            // Fetch data from the API and update content
            fetch('/api/data/dashboard-stats-admin')
                .then(response => response.json())
                .then(data => {
                    // Dynamically update the popup content with the fetched data
                    document.getElementById('absent-today').textContent = data.data.absent_today;
                    document.getElementById('present-today').textContent = data.data.present_today;
                    document.getElementById('total-employees').textContent = data.data.total_employees;
                    document.getElementById('work-from-office').textContent = data.data.total_work_from_office;
                    document.getElementById('work-from-home').textContent = data.data.total_work_from_home;
                    document.getElementById('work-from-field').textContent = data.data.total_work_from_field;
                })
                .catch(error => {
                    // Handle error if API fetch fails
                    const contentElement = document.getElementById('popup-content');
                    contentElement.innerHTML = 'Failed to load data. Please try again later.';
                    console.error('Error fetching data:', error);
                });

            // Close the popup when the close button is clicked
            popup.querySelector('.close-popup').addEventListener('click', function () {
                document.body.removeChild(popup);
                document.body.removeChild(overlay);
            });

            // Remove popup and overlay when overlay is clicked
            overlay.addEventListener('click', function () {
                document.body.removeChild(popup);
                document.body.removeChild(overlay);
            });
        }





        renderSimpleCalendar();
    }
</script>
</body>
</html>
